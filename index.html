<!doctype html>
<html lang="es">
<head>
  <!-- =========================================================
       LISTA COMPARTIDA (PWA) ‚Äî Estructura base, clara y extensible
       - Sin Firebase a√∫n (se integra despu√©s sin reestructurar UI)
       - Mobile-first, accesible, sin dependencias
       - Dise√±ada para no ‚Äútocar mil zonas‚Äù al iterar
       ========================================================= -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Lista ‚Ä¢ PWA</title>

  <!-- =========================================================
       METADATOS PARA WHATSAPP (TARJETA)
       - WhatsApp usa Open Graph para mostrar una tarjeta bonita.
       - El payload de importaci√≥n va en el hash (#...), que el crawler no necesita.
       ========================================================= -->
  <meta property="og:title" content="Lista de la compra" />
  <meta property="og:description" content="Toca para abrir la lista en la app (reemplaza la lista actual tras confirmaci√≥n)." />
  <!-- Cambia esta imagen por una tuya en el repo (recomendado) -->
  <meta property="og:image" content="icon-512.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />


  <!-- (Opcional) PWA Manifest: crea manifest.json aparte cuando quieras -->
  <!-- <link rel="manifest" href="manifest.json"> -->

  <!-- =========================================================
       ESTILOS ‚Äî Todo lo visual concentrado aqu√≠
       Objetivo: tocar CSS sin tocar HTML/JS
       ========================================================= -->
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --edge:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#4f8cff;
      --danger:#ff4f4f;

      --radius:16px;
      --gap:12px;
      --max:980px;
      --tap:44px; /* tama√±o m√≠nimo recomendado para toque */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font: 15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 0%, #142048, transparent 55%),
        radial-gradient(1200px 900px at 90% 10%, #0c2a3e, transparent 55%),
        linear-gradient(180deg, #070b14, #0b1220 40%, #070b14);
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Contenedor principal */
    .app{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 12px calc(12px + var(--tap));
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      min-height:100%;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--edge);
      border-radius:var(--radius);
      background:rgba(17,26,46,.60);
      backdrop-filter: blur(10px) saturate(140%);
    }
    .brand{
      display:flex; align-items:baseline; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .brand small{
      font-weight:600; color:var(--muted);
      letter-spacing:.06em; text-transform:uppercase;
      font-size:11px;
    }

    /* Botones base */
    .btn{
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(79,140,255,.18);
      border-color:rgba(79,140,255,.35);
    }
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.14);
    }
    .btn.danger{
      background:rgba(255,79,79,.14);
      border-color:rgba(255,79,79,.30);
    }

    /* √Årea de pantallas (Inicio / Buscar / Lista) */
    .screen{
      display:none;
      border:1px solid var(--edge);
      border-radius:var(--radius);
      background:rgba(17,26,46,.52);
      backdrop-filter: blur(10px) saturate(140%);
      padding:12px;
    }
    .screen.is-active{display:block}

    /* T√≠tulos de secci√≥n */
    .h1{margin:2px 0 10px; font-size:18px; font-weight:800}
    .hint{margin:0 0 12px; color:var(--muted)}

    /* Inicio */
    .home-actions{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:720px){
      .home-actions{grid-template-columns:1fr 1fr}
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:14px;
      background:rgba(0,0,0,.12);
    }
    .card .title{font-weight:800; font-size:16px; margin:0 0 6px}
    .card .desc{color:var(--muted); margin:0 0 12px}

    /* Buscar */
    .searchbar{
      display:flex; gap:10px; align-items:center;
      margin-bottom:12px;
    }
    .input{
      flex:1;
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
    }
    .input::placeholder{color:rgba(255,255,255,.45)}

    /* Grid de productos */
    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(min-width:520px){ .grid{grid-template-columns:repeat(4, 1fr)} }
    @media(min-width:820px){ .grid{grid-template-columns:repeat(6, 1fr)} }

    .pitem{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height:120px;
    }
    .pitem:active{transform:translateY(1px)}
    .pitem .img{
      width:100%;
      aspect-ratio: 1 / 1;
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pitem img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .pitem .label{
      padding:8px 10px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
      color:rgba(255,255,255,.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Opci√≥n "A√±adir lo escrito" */
    .add-free{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.10);
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .add-free.is-visible{display:flex}
    .add-free .text{color:var(--muted)}
    .add-free strong{color:var(--txt)}

    /* Lista */
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .li{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:10px;
    }
    .thumb{
      width:56px; height:56px;
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; color:rgba(255,255,255,.55);
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .li .meta{flex:1; min-width:0}
    .li .name{font-weight:800; margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .li .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .qty{
      display:inline-flex; align-items:center; gap:8px;
      flex:0 0 auto;
    }
    .pill{
      min-width:42px;
      text-align:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-weight:800;
    }

    /* Barra inferior fija: solo dos modos (Buscar / Lista) */
    .bottombar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(7,11,20,.72);
      backdrop-filter: blur(14px) saturate(140%);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .bottombar-inner{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .bottombar .btn{
      flex:1;
      border-radius:14px;
      font-weight:800;
    }

    /* =========================================================
       PANEL DETALLE (Bottom Sheet)
       - Se usa tanto desde Buscar como desde Lista
       - Cierra y vuelve al origen autom√°ticamente
       ========================================================= */
    .sheet-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
    }
    .sheet-backdrop.is-open{display:flex}

    .sheet{
      width:min(var(--max), 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(17,26,46,.92);
      backdrop-filter: blur(14px) saturate(160%);
      overflow:hidden;
    }
    .sheet-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheet-title{font-weight:900}
    .sheet-body{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
    }
    @media(min-width:760px){
      .sheet-body{grid-template-columns: 1.2fr .8fr}
    }
    .sheet-photo{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      aspect-ratio: 4 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,.55);
      font-weight:900;
      letter-spacing:.06em;
    }
    .sheet-photo img{width:100%; height:100%; object-fit:cover; display:block}

    .sheet-controls{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.12);
    }
    .row .k{color:var(--muted); font-weight:700}
    .qty-ctrl{
      display:flex; align-items:center; gap:8px;
    }
    .qty-btn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .qty-val{
      width:56px;
      text-align:center;
      font-weight:900;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      padding:10px 0;
    }
    .sheet-actions{
      display:flex;
      gap:10px;
    }
    .sheet-actions .btn{flex:1}

    /* Di√°logo simple (confirmaci√≥n borrar lista) */
    dialog{
      border:none;
      border-radius:18px;
      padding:0;
      width:min(520px, calc(100% - 24px));
      background:rgba(17,26,46,.98);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
    }
    .dlg{
      padding:14px;
    }
    .dlg h3{margin:0 0 6px; font-size:16px}
    .dlg p{margin:0 0 12px; color:var(--muted)}
    .dlg .actions{display:flex; gap:10px; justify-content:flex-end}
  </style>
</head>

<body>
  <main class="app">
    <!-- =========================================================
         TOPBAR ‚Äî T√≠tulo y estado
         * IMPORTANTE: aqu√≠ NO metemos navegaci√≥n para no duplicar
           la barra inferior (m√≥vil).
         ========================================================= -->
    <header class="topbar">
      <div class="brand">
        <span>Lista</span>
        <small id="appStatus">offline/online</small>
      </div>

      <!-- Hueco para futuras acciones globales sin tocar otras zonas -->
    </header>

    <!-- =========================================================
         SCREEN: INICIO
         - Dos accesos grandes: Buscar / Lista
         ========================================================= -->
    <section id="screenHome" class="screen is-active" aria-label="Inicio">
      <div class="h1">Inicio</div>
      <p class="hint">Elige qu√© quieres hacer.</p>

      <div class="home-actions">
        <div class="card">
          <p class="title">Buscar productos</p>
          <p class="desc">Escribe o busca por fotos. A√±ade sin salir del buscador.</p>
          <button class="btn primary" type="button" data-nav="search">Ir a Buscar</button>
        </div>

        <div class="card">
          <p class="title">Ver lista</p>
          <p class="desc">Revisa lo a√±adido, ajusta cantidades y elimina la lista si hace falta.</p>
          <button class="btn primary" type="button" data-nav="list">Ir a Lista</button>
        </div>
      </div>
    </section>

    <!-- =========================================================
         SCREEN: BUSCAR
         - Input siempre visible
         - Grid visual
         - "Fuera de lista": a√±adir texto escrito si no hay resultado
         ========================================================= -->
    <section id="screenSearch" class="screen" aria-label="Buscar">
      <div class="h1">Buscar</div>

      <div class="searchbar">
        <input id="searchInput" class="input" type="search" inputmode="search"
               placeholder="Escribe lo que buscas (ej. arroz, lej√≠a, pilas‚Ä¶)" autocomplete="off" />
        <button id="btnClearSearch" class="btn ghost" type="button" title="Limpiar">Limpiar</button>
      </div>

      <!-- Grid de resultados (productos con imagen) -->
      <div id="productGrid" class="grid" role="list" aria-label="Resultados"></div>

      <!-- Opci√≥n: a√±adir texto libre ("fuera de lista") -->
      <div id="addFreeBox" class="add-free" aria-live="polite">
        <div class="text">
          No se encontr√≥ coincidencia. A√±adir: <strong id="freeText"></strong>
        </div>
        <button id="btnAddFree" class="btn primary" type="button">A√±adir</button>
      </div>

      <p class="hint" style="margin-top:12px">
        Consejo: escribe parte del nombre (b√∫squeda por <strong>contiene</strong>).
      </p>
    </section>

    <!-- =========================================================
         SCREEN: LISTA
         - Orden de inserci√≥n
         - Foto+nombre+cantidad / texto+cantidad si "fuera de lista"
         - Bot√≥n "Eliminar lista" con confirmaci√≥n
         ========================================================= -->
    <section id="screenList" class="screen" aria-label="Lista">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="h1" style="margin:0">Lista</div>
        <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnShareList" class="btn ghost" type="button">Compartir</button>
        <button id="btnDeleteList" class="btn danger" type="button">Eliminar lista</button>
      </div>
      </div>
      <p class="hint">El primer producto a√±adido aparece el primero.</p>

      <div id="shoppingList" class="list" aria-label="Productos en la lista"></div>

      <p id="emptyListHint" class="hint" style="display:none">
        La lista est√° vac√≠a. Ve a Buscar para a√±adir productos.
      </p>
    </section>
  </main>

  <!-- =========================================================
       BOTTOM BAR ‚Äî Navegaci√≥n fija (Buscar / Lista)
       - Para m√≥vil: siempre visible, evita ‚Äúvolver atr√°s‚Äù
       - El Inicio se alcanza entrando por primera vez o con gesto back del SO
         (si quieres un bot√≥n "Inicio", se a√±ade aqu√≠ sin tocar pantallas)
       ========================================================= -->
  <nav class="bottombar" aria-label="Navegaci√≥n">
    <div class="bottombar-inner">
      <button class="btn ghost" type="button" data-nav="search">üîç Buscar</button>
      <button class="btn ghost" type="button" data-nav="list">üõí Lista</button>
    </div>
  </nav>

  <!-- =========================================================
       SHEET DETALLE ‚Äî Reutilizable desde Buscar y desde Lista
       Contrato:
       - openDetail({ name, img, qty, mode })
       - mode: "add" (desde buscar) o "edit" (desde lista)
       ========================================================= -->
  <div id="detailBackdrop" class="sheet-backdrop" role="presentation">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Detalle del producto">
      <div class="sheet-head">
        <div class="sheet-title" id="detailTitle">Producto</div>
        <button id="btnCloseDetail" class="btn ghost" type="button" aria-label="Cerrar">Cerrar</button>
      </div>

      <div class="sheet-body">
        <div class="sheet-photo" id="detailPhoto">
          <!-- imagen grande si existe -->
          <span id="detailPhotoFallback">SIN FOTO</span>
        </div>

        <div class="sheet-controls">
          <div class="row">
            <div class="k">Cantidad</div>
            <div class="qty-ctrl">
              <button id="btnQtyMinus" class="qty-btn" type="button" aria-label="Restar">‚àí</button>
              <div id="detailQty" class="qty-val" aria-label="Cantidad">1</div>
              <button id="btnQtyPlus" class="qty-btn" type="button" aria-label="Sumar">+</button>
            </div>
          </div>

          <!-- Zona reservada para info futura sin tocar el layout -->
          <div class="row" id="detailInfoRow" style="display:none">
            <div class="k">Info</div>
            <div id="detailInfo" style="font-weight:800"></div>
          </div>

          <div class="sheet-actions">
            <button id="btnConfirmDetail" class="btn primary" type="button">A√±adir</button>
            <button id="btnDeleteItem" class="btn danger" type="button" style="display:none">Borrar</button>
          </div>

          <p class="hint" style="margin:0">
            Al cerrar vuelves a donde estabas (Buscar o Lista).
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
       DIALOG: Confirmaci√≥n borrar lista
       ========================================================= -->
  <dialog id="dlgDeleteList">
    <div class="dlg">
      <h3>Eliminar lista</h3>
      <p>Se borrar√°n todos los productos de la lista. ¬øSeguro?</p>
      <div class="actions">
        <button id="dlgCancel" class="btn ghost" type="button">Cancelar</button>
        <button id="dlgConfirm" class="btn danger" type="button">Eliminar</button>
      </div>
    </div>
  </dialog>

  <!-- =========================================================
       DIALOG: Confirmaci√≥n importar lista (reemplaza la actual)
       Se abre autom√°ticamente si la URL trae #i=...
       ========================================================= -->
  <dialog id="dlgImportList">
    <div class="dlg">
      <h3>Importar lista</h3>
      <p>Esta lista sustituir√° la lista actual. ¬øContinuar?</p>
      <div class="actions">
        <button id="dlgImportCancel" class="btn ghost" type="button">Cancelar</button>
        <button id="dlgImportConfirm" class="btn primary" type="button">Continuar</button>
      </div>
    </div>
  </dialog>

  <!-- =========================================================
       SCRIPT ‚Äî Sin Firebase a√∫n. Arquitectura preparada para a√±adirlo.
       Principios:
       - Un √∫nico ‚Äúestado‚Äù central (state)
       - Render por funciones puras (renderSearch / renderList)
       - Contratos DOM estables (IDs arriba). Si cambias UI, no rompes l√≥gica.
       - Cat√°logo abierto: productos con foto + texto libre fuera de lista
       ========================================================= -->
  <script type="module">
    /* =========================================================
       1) CONFIG (f√°cil de tocar sin tocar l√≥gica)
       ========================================================= */
    const CONFIG = {
      // Carpeta donde pondr√°s tus screenshots
      imageBasePath: "./images/",
      // Cat√°logo inicial (ejemplo). Puedes ampliarlo sin tocar l√≥gica.
      // name: se muestra y se usa para b√∫squeda. img: nombre de archivo (opcional).
      catalog: [
        { name: "LECHE", img: "leche.jpg" },
        { name: "PAN", img: "panintegral.jpg" },
        { name: "HUEVOS", img: "huevos.jpg" },
        { name: "AGUA", img: "agua.jpg" },
        { name: "TIRAS", img: "tiras.jpg" },
        { name: "ACEITE", img: "aceite.jpg" },
        { name: "AZ√öCAR", img: "azucar.jpg" },
        { name: "SAL", img: "sal.jpg" },
        { name: "YOGUR", img: "yogurgrande.jpg" },
      ]
    };

    /* =========================================================
       2) ESTADO CENTRAL (una sola fuente de verdad)
       - En el futuro, Firebase ‚Äúrellena‚Äù y ‚Äúescucha‚Äù este estado.
       ========================================================= */
    const state = {
      // navegaci√≥n
      activeScreen: "home", // "home" | "search" | "list"
      // b√∫squeda
      searchText: "",
      // lista (orden de inserci√≥n)
      items: [
        // { id, name, qty, img? , order }
      ],
      // detalle
      detail: {
        isOpen: false,
        origin: "search", // "search" | "list"
        mode: "add",      // "add" | "edit"
        itemId: null,
        name: "",
        img: null,
        qty: 1
      }
    };

    /* =========================================================
       3) UTILIDADES (peque√±as y aisladas)
       ========================================================= */
    const $ = (sel, root=document) => root.querySelector(sel);

    const norm = (s) => (s ?? "")
      .toString()
      .trim()
      .toUpperCase();

    const contains = (haystack, needle) => {
      const h = norm(haystack);
      const n = norm(needle);
      return n.length === 0 ? true : h.includes(n);
    };

    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));

    const imgUrl = (imgName) => imgName ? (CONFIG.imageBasePath + imgName) : null;

    /* =========================================================
       3.1) COMPARTIR / IMPORTAR POR ENLACE (sin backend)
       - Compartir: generamos un enlace con #i=PAYLOAD
       - Importar: al abrir ese enlace, pedimos confirmaci√≥n (B) y reemplazamos lista
       Nota: el payload NO incluye fotos (solo el nombre de archivo), porque las fotos viven en la app.
       ========================================================= */
    function b64urlEncode(str){
      const b64 = btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    }
    function b64urlDecode(b64url){
      const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
      const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
      const bin = atob(b64 + pad);
      return decodeURIComponent(escape(bin));
    }

    function buildSharePayload(){
      return { v: 1, items: state.items };
    }

    function buildShareUrl(){
      const payload = JSON.stringify(buildSharePayload());
      const token = b64urlEncode(payload);
      const base = location.origin + location.pathname;
      return base + "#i=" + token;
    }

    function readImportTokenFromHash(){
      const h = location.hash || "";
      const m = h.match(/[#&]i=([^&]+)/);
      return m ? m[1] : null;
    }

    function clearImportToken(){
      history.replaceState(null, "", location.pathname + location.search);
    }

    /* =========================================================
       4) NAVEGACI√ìN (solo cambia state.activeScreen)
       ========================================================= */
    function navTo(screen){
      state.activeScreen = screen;
      render();
    }

    /* =========================================================
       5) RENDER: pantalla activa + subrenders
       ========================================================= */
    function render(){
      $("#screenHome").classList.toggle("is-active", state.activeScreen === "home");
      $("#screenSearch").classList.toggle("is-active", state.activeScreen === "search");
      $("#screenList").classList.toggle("is-active", state.activeScreen === "list");

      $("#appStatus").textContent = navigator.onLine ? "online" : "offline";

      renderSearch();
      renderList();
      renderDetail();
    }

    function renderSearch(){
      if (state.activeScreen !== "search") return;

      $("#searchInput").value = state.searchText;

      const results = CONFIG.catalog.filter(p => contains(p.name, state.searchText));

      const grid = $("#productGrid");
      grid.innerHTML = "";
      for (const p of results){
        const el = document.createElement("div");
        el.className = "pitem";
        el.setAttribute("role","listitem");
        el.innerHTML = `
          <div class="img">${p.img ? `<img alt="${p.name}" src="${imgUrl(p.img)}" loading="lazy">` : ""}</div>
          <div class="label" title="${p.name}">${p.name}</div>
        `;
        el.addEventListener("click", () => openDetailFromSearch(p));
        grid.appendChild(el);
      }

      const showFree = norm(state.searchText).length > 0 && results.length === 0;
      $("#addFreeBox").classList.toggle("is-visible", showFree);
      $("#freeText").textContent = norm(state.searchText);
    }

    function renderList(){
      if (state.activeScreen !== "list") return;

      const wrap = $("#shoppingList");
      wrap.innerHTML = "";

      const items = [...state.items].sort((a,b)=>a.order-b.order);

      $("#emptyListHint").style.display = items.length ? "none" : "block";

      for (const it of items){
        const li = document.createElement("div");
        li.className = "li";

        const thumb = it.img
          ? `<div class="thumb"><img alt="${it.name}" src="${imgUrl(it.img)}" loading="lazy"></div>`
          : `<div class="thumb" aria-hidden="true">‚Äî</div>`;

        li.innerHTML = `
          ${thumb}
          <div class="meta">
            <p class="name" title="${it.name}">${it.name}</p>
            <p class="sub">${it.img ? "Con foto" : "Sin foto"}</p>
          </div>
          <div class="qty">
            <div class="pill" aria-label="Cantidad">${it.qty}</div>
            <button class="btn ghost" type="button" data-act="delete" title="Eliminar">üóëÔ∏è</button>
          </div>
        `;

        li.addEventListener("click", (ev)=>{
          const btn = ev.target.closest('button[data-act="delete"]');
          if (btn) return;
          openDetailFromList(it);
        });

        li.querySelector('button[data-act="delete"]').addEventListener("click", (ev)=>{
          ev.stopPropagation();
          deleteItem(it.id);
        });

        wrap.appendChild(li);
      }
    }

    function renderDetail(){
      $("#detailBackdrop").classList.toggle("is-open", state.detail.isOpen);
      if (!state.detail.isOpen) return;

      $("#detailTitle").textContent = state.detail.name;
      $("#detailQty").textContent = String(state.detail.qty);

      const photo = $("#detailPhoto");
      photo.innerHTML = "";
      if (state.detail.img){
        const img = document.createElement("img");
        img.alt = state.detail.name;
        img.src = imgUrl(state.detail.img);
        img.loading = "lazy";
        photo.appendChild(img);
      }else{
        const span = document.createElement("span");
        span.textContent = "SIN FOTO";
        photo.appendChild(span);
      }

      const isEdit = state.detail.mode === "edit";
      $("#btnConfirmDetail").textContent = isEdit ? "Actualizar" : "A√±adir";
      $("#btnDeleteItem").style.display = isEdit ? "inline-flex" : "none";
    }

    /* =========================================================
       6) ACCIONES: abrir/cerrar detalle (origen recordado)
       ========================================================= */
    function openDetailFromSearch(p){
      state.detail = { isOpen:true, origin:"search", mode:"add", itemId:null, name:p.name, img:p.img||null, qty:1 };
      renderDetail();
    }

    function openDetailFromList(it){
      state.detail = { isOpen:true, origin:"list", mode:"edit", itemId:it.id, name:it.name, img:it.img||null, qty:it.qty };
      renderDetail();
    }

    function closeDetail(){
      const origin = state.detail.origin;
      state.detail.isOpen = false;
      render();
      navTo(origin);
    }

    /* =========================================================
       7) MUTACIONES SOBRE LA LISTA (√∫nico sitio donde se toca state.items)
       En el futuro aqu√≠ se conectan las llamadas a Firebase.
       ========================================================= */
    function addItem({ name, img=null, qty=1 }){
      const order = state.items.length ? Math.max(...state.items.map(x=>x.order)) + 1 : 1;
      state.items.push({ id: uid(), name: norm(name), img, qty: Math.max(1, qty|0), order });
      render();
    }

    function updateItem(id, patch){
      const it = state.items.find(x=>x.id===id);
      if (!it) return;
      if (patch.qty != null) it.qty = Math.max(1, patch.qty|0);
      render();
    }

    function deleteItem(id){
      state.items = state.items.filter(x=>x.id!==id);
      render();
    }

    function clearList(){
      state.items = [];
      render();
    }

    /* =========================================================
       8) EVENTOS DOM (wiring en un solo lugar)
       ========================================================= */
    document.addEventListener("click", (ev)=>{
      const b = ev.target.closest("[data-nav]");
      if (!b) return;
      const screen = b.dataset.nav;
      if (screen === "search") navTo("search");
      if (screen === "list") navTo("list");
    });

    $("#searchInput").addEventListener("input", (ev)=>{
      state.searchText = ev.target.value || "";
      renderSearch();
    });

    $("#btnClearSearch").addEventListener("click", ()=>{
      state.searchText = "";
      renderSearch();
      $("#searchInput").focus();
    });

    $("#btnAddFree").addEventListener("click", ()=>{
      const name = norm(state.searchText);
      if (!name) return;
      addItem({ name, img: null, qty: 1 });
    });

    $("#btnCloseDetail").addEventListener("click", closeDetail);
    $("#detailBackdrop").addEventListener("click", (ev)=>{
      if (ev.target === $("#detailBackdrop")) closeDetail();
    });

    $("#btnQtyMinus").addEventListener("click", ()=>{
      state.detail.qty = Math.max(1, state.detail.qty - 1);
      renderDetail();
    });
    $("#btnQtyPlus").addEventListener("click", ()=>{
      state.detail.qty = state.detail.qty + 1;
      renderDetail();
    });

    $("#btnConfirmDetail").addEventListener("click", ()=>{
      if (state.detail.mode === "add"){
        addItem({ name: state.detail.name, img: state.detail.img, qty: state.detail.qty });
        closeDetail(); // vuelve al origen (Buscar)
      }else{
        updateItem(state.detail.itemId, { qty: state.detail.qty });
        closeDetail(); // vuelve al origen (Lista)
      }
    });

    $("#btnDeleteItem").addEventListener("click", ()=>{
      if (state.detail.mode !== "edit") return;
      deleteItem(state.detail.itemId);
      closeDetail();
    });


    // Compartir lista (WhatsApp / compartir nativo / copiar)
    $("#btnShareList").addEventListener("click", async ()=>{
      const url = buildShareUrl();

      try{
        if (navigator.share){
          await navigator.share({ title: "Lista de la compra", text: "Abre esta lista en la app:", url });
          return;
        }
      }catch(e){
        // cancelado por el usuario: no hacemos nada
      }

      try{
        await navigator.clipboard.writeText(url);
        alert("Enlace copiado. P√©galo en WhatsApp.");
      }catch(e){
        prompt("Copia este enlace y p√©galo en WhatsApp:", url);
      }
    });

    $("#btnDeleteList").addEventListener("click", ()=>{
      $("#dlgDeleteList").showModal();
    });
    $("#dlgCancel").addEventListener("click", ()=>$("#dlgDeleteList").close());
    $("#dlgConfirm").addEventListener("click", ()=>{
      $("#dlgDeleteList").close();
      clearList();
    });

    // Importar lista (confirmaci√≥n B)
    $("#dlgImportCancel").addEventListener("click", ()=>{
      $("#dlgImportList").close();
      clearImportToken();
      render();
    });
    $("#dlgImportConfirm").addEventListener("click", ()=>{
      $("#dlgImportList").close();
      const token = readImportTokenFromHash();
      if (!token){
        clearImportToken();
        render();
        return;
      }
      try{
        const jsonStr = b64urlDecode(token);
        const payload = JSON.parse(jsonStr);
        if (payload && payload.v === 1 && Array.isArray(payload.items)){
          state.items = payload.items;
          saveStateToStorage();
        }else{
          throw new Error("bad payload");
        }
      }catch(e){
        alert("No se pudo importar la lista (enlace inv√°lido).");
      }
      clearImportToken();
      navTo("list");
    });



    window.addEventListener("online", render);
    window.addEventListener("offline", render);

    /* =========================================================
       9) ARRANQUE
       ========================================================= */

    // 1) Si hay importaci√≥n por enlace (#i=...), NO dependemos de lo local.
    const m = (location.hash || "").match(/[#&]i=([^&]+)/);
    const importToken = m ? m[1] : null;

    if (importToken){
      // Si existe un di√°logo de importaci√≥n (modo B), √∫salo.
      const dlg = document.getElementById("dlgImportList");
      if (dlg && typeof dlg.showModal === "function"){
        render();          // pinta base
        dlg.showModal();   // confirmaci√≥n B
        // El resto (Continuar/Cancelar) lo resuelves con los handlers del di√°logo.
        // Si no tienes handlers, abajo tienes fallback autom√°tico.
        return;
      }

      // Fallback m√≠nimo: confirmaci√≥n B sin di√°logo
      render();
      const ok = confirm("Esta lista sustituir√° la lista actual. ¬øContinuar?");
      if (!ok){
        // Evita re-importar al recargar
        history.replaceState(null, "", location.pathname + location.search);
        return;
      }

      try{
        // Decode Base64URL -> JSON
        const b64 = importToken.replace(/-/g, "+").replace(/_/g, "/");
        const pad = b64.length % 4 ? "=".repeat(4 - (b64.length % 4)) : "";
        const jsonStr = decodeURIComponent(escape(atob(b64 + pad)));
        const payload = JSON.parse(jsonStr);

        if (payload && Array.isArray(payload.items)){
          // Reemplazo total
          state.items = payload.items;

          if (typeof saveStateToStorage === "function") saveStateToStorage();
        }
      }catch(e){
        alert("No se pudo importar la lista (enlace inv√°lido).");
      }

      // Limpia hash y muestra lista
      history.replaceState(null, "", location.pathname + location.search);
      if (typeof navTo === "function") navTo("list");
      else render();
      return;
    }

    // 2) Arranque normal: cargar local (si existe) y renderizar
    if (typeof loadStateFromStorage === "function") loadStateFromStorage();
    render();
  </script>
</body>
</html>
