<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Lista ‚Ä¢ PWA</title>

  <meta property="og:title" content="Lista de la compra" />
  <meta property="og:description" content="Toca para abrir la lista en la app (reemplaza la lista actual tras confirmaci√≥n)." />
  <meta property="og:image" content="icon-512.png" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --edge:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#4f8cff;
      --danger:#ff4f4f;

      --radius:16px;
      --gap:12px;
      --max:980px;
      --tap:44px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--txt);
      font: 15px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 0%, #142048, transparent 55%),
        radial-gradient(1200px 900px at 90% 10%, #0c2a3e, transparent 55%),
        linear-gradient(180deg, #070b14, #0b1220 40%, #070b14);
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .app{
      max-width:var(--max);
      margin:0 auto;
      padding:12px 12px calc(12px + var(--tap));
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      min-height:100%;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--edge);
      border-radius:var(--radius);
      background:rgba(17,26,46,.60);
      backdrop-filter: blur(10px) saturate(140%);
    }
    .brand{
      display:flex; align-items:baseline; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .brand small{
      font-weight:600; color:var(--muted);
      letter-spacing:.06em; text-transform:uppercase;
      font-size:11px;
    }

    .btn{
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(79,140,255,.18);
      border-color:rgba(79,140,255,.35);
    }
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.14);
    }
    .btn.danger{
      background:rgba(255,79,79,.14);
      border-color:rgba(255,79,79,.30);
    }

    .screen{
      display:none;
      border:1px solid var(--edge);
      border-radius:var(--radius);
      background:rgba(17,26,46,.52);
      backdrop-filter: blur(10px) saturate(140%);
      padding:12px;
    }
    .screen.is-active{display:block}

    .h1{margin:2px 0 10px; font-size:18px; font-weight:800}
    .hint{margin:0 0 12px; color:var(--muted)}

    .searchbar{
      display:flex; gap:10px; align-items:center;
      margin-bottom:12px;
    }
    .input{
      flex:1;
      min-height:var(--tap);
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--txt);
      outline:none;
    }
    .input::placeholder{color:rgba(255,255,255,.45)}

    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(min-width:520px){ .grid{grid-template-columns:repeat(4, 1fr)} }
    @media(min-width:820px){ .grid{grid-template-columns:repeat(6, 1fr)} }

    .pitem{
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      min-height:120px;
    }
    .pitem:active{transform:translateY(1px)}
    .pitem .img{
      width:100%;
      aspect-ratio: 1 / 1;
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .pitem img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .pitem .label{
      padding:8px 10px;
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
      color:rgba(255,255,255,.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .add-free{
      margin-top:12px;
      padding:12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(0,0,0,.10);
      display:none;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .add-free.is-visible{display:flex}
    .add-free .text{color:var(--muted)}
    .add-free strong{color:var(--txt)}

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .li{
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:10px;
    }
    .thumb{
      width:56px; height:56px;
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-weight:800; color:rgba(255,255,255,.55);
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .li .meta{flex:1; min-width:0}
    .li .name{font-weight:800; margin:0; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .li .sub{margin:2px 0 0; color:var(--muted); font-size:12px}
    .qty{
      display:inline-flex; align-items:center; gap:8px;
      flex:0 0 auto;
    }
    .pill{
      min-width:42px;
      text-align:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-weight:800;
    }

    .bottombar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(7,11,20,.72);
      backdrop-filter: blur(14px) saturate(140%);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .bottombar-inner{
      max-width:var(--max);
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .bottombar .btn{
      flex:1;
      border-radius:14px;
      font-weight:800;
    }

    .sheet-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:12px;
    }
    .sheet-backdrop.is-open{display:flex}

    .sheet{
      width:min(var(--max), 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(17,26,46,.92);
      backdrop-filter: blur(14px) saturate(160%);
      overflow:hidden;
    }
    .sheet-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .sheet-title{font-weight:900}
    .sheet-body{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
    }
    @media(min-width:760px){
      .sheet-body{grid-template-columns: 1.2fr .8fr}
    }
    .sheet-photo{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      aspect-ratio: 4 / 3;
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,.55);
      font-weight:900;
      letter-spacing:.06em;
    }
    .sheet-photo img{width:100%; height:100%; object-fit:cover; display:block}

    .sheet-controls{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      background:rgba(0,0,0,.12);
    }
    .row .k{color:var(--muted); font-weight:700}
    .qty-ctrl{
      display:flex; align-items:center; gap:8px;
    }
    .qty-btn{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      font-size:18px;
      font-weight:900;
      cursor:pointer;
    }
    .qty-val{
      width:56px;
      text-align:center;
      font-weight:900;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      padding:10px 0;
    }
    .sheet-actions{
      display:flex;
      gap:10px;
    }
    .sheet-actions .btn{flex:1}

    dialog{
      border:none;
      border-radius:18px;
      padding:0;
      width:min(520px, calc(100% - 24px));
      background:rgba(17,26,46,.98);
      color:var(--txt);
      border:1px solid rgba(255,255,255,.14);
    }
    .dlg{
      padding:14px;
    }
    .dlg h3{margin:0 0 6px; font-size:16px}
    .dlg p{margin:0 0 12px; color:var(--muted)}
    .dlg .actions{display:flex; gap:10px; justify-content:flex-end}
    input,
textarea,
select {
  font-size: 16px;
}
.btn.primary:active,
.btn.primary:hover{
  background: rgba(40, 200, 120, .35);
  border-color: rgba(40, 200, 120, .75);
  box-shadow:
    0 0 0 3px rgba(40, 200, 120, .25),
    0 8px 22px rgba(40, 200, 120, .45);
}
  </style>
</head>

<body>
  <main class="app">
   
      
    </header>

    <!-- SCREEN: BUSCAR (default si NO vienes con ?list=) -->
    <section id="screenSearch" class="screen is-active" aria-label="Buscar">
      <div class="h1">Buscar</div>

      <div class="searchbar">
        <input id="searchInput" class="input" type="search" inputmode="search"
                autocomplete="off" />
        
      </div>

      <div id="productGrid" class="grid" role="list" aria-label="Resultados"></div>

      <div id="addFreeBox" class="add-free" aria-live="polite">
        <div class="text">
          No se encontr√≥ coincidencia. A√±adir: <strong id="freeText"></strong>
        </div>
        <button id="btnAddFree" class="btn primary" type="button">A√±adir</button>
      </div>

      
    </section>

    <!-- SCREEN: LISTA -->
    <section id="screenList" class="screen" aria-label="Lista">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div class="h1" style="margin:0">Lista</div>
        <div style="display:flex; gap:10px; align-items:center;">

          <button id="btnDeleteList" class="btn danger" type="button">Eliminar lista</button>
        </div>
      </div>


      <div id="shoppingList" class="list" aria-label="Productos en la lista"></div>

     
    </section>
  </main>

  <!-- NAV inferior -->
  <nav class="bottombar" aria-label="Navegaci√≥n">
    <div class="bottombar-inner">
      <button class="btn ghost" type="button" data-nav="search">üîç Buscar</button>
      <button class="btn ghost" type="button" data-nav="list">üõí Lista</button>
    </div>
  </nav>

  <!-- SHEET detalle -->
  <div id="detailBackdrop" class="sheet-backdrop" role="presentation">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Detalle del producto">
      <div class="sheet-head">
        <div class="sheet-title" id="detailTitle">Producto</div>
        <button id="btnCloseDetail" class="btn ghost" type="button" aria-label="Cerrar">Cerrar</button>
      </div>

      <div class="sheet-body">
        <div class="sheet-photo" id="detailPhoto">
          <span id="detailPhotoFallback">SIN FOTO</span>
        </div>

        <div class="sheet-controls">
          <div class="row">
            <div class="k">Cantidad</div>
            <div class="qty-ctrl">
              <button id="btnQtyMinus" class="qty-btn" type="button" aria-label="Restar">‚àí</button>
              <div id="detailQty" class="qty-val" aria-label="Cantidad">1</div>
              <button id="btnQtyPlus" class="qty-btn" type="button" aria-label="Sumar">+</button>
            </div>
          </div>

          <div class="row" id="detailInfoRow" style="display:none">
            <div class="k">Info</div>
            <div id="detailInfo" style="font-weight:800"></div>
          </div>

          <div class="sheet-actions">
            <button id="btnConfirmDetail" class="btn primary" type="button">A√±adir</button>
            <button id="btnDeleteItem" class="btn danger" type="button" style="display:none">Borrar</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Dialog borrar -->
  <dialog id="dlgDeleteList">
    <div class="dlg">
      <h3>Eliminar lista</h3>
      <p>Se borrar√°n todos los productos de la lista. ¬øSeguro?</p>
      <div class="actions">
        <button id="dlgCancel" class="btn ghost" type="button">Cancelar</button>
        <button id="dlgConfirm" class="btn danger" type="button">Eliminar</button>
      </div>
    </div>
  </dialog>

<script type="module">
/* =========================================================
   FIREBASE / FIRESTORE ‚Äî SIN BUILD, SIN NPM
   ========================================================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC5DOjHH9hWMWotY7OWzdEV7PGBNkkohR8",
  authDomain: "compra-250f9.firebaseapp.com",
  projectId: "compra-250f9",
  storageBucket: "compra-250f9.firebasestorage.app",
  messagingSenderId: "329069667450",
  appId: "1:329069667450:web:d063aed6336a9382f447c3"
};

const firebaseApp = initializeApp(firebaseConfig);
const db = getFirestore(firebaseApp);

const LS_LIST_ID = "pwa_list_id_v1";
let LIST_ID = null;
let cloudSaveTimer = null;

function newId(){ return crypto.randomUUID(); }
function readListIdFromUrl(){ return new URL(location.href).searchParams.get("list"); }
function setListIdInUrl(id){
  const u = new URL(location.href);
  u.searchParams.set("list", id);
  history.replaceState(null, "", u.toString());
}
function ensureListId(){
  const fromUrl = readListIdFromUrl();
  if (fromUrl){ localStorage.setItem(LS_LIST_ID, fromUrl); return fromUrl; }
  const fromLocal = localStorage.getItem(LS_LIST_ID);
  if (fromLocal) return fromLocal;
  const id = newId();
  localStorage.setItem(LS_LIST_ID, id);
  setListIdInUrl(id);
  return id;
}

async function cloudInit(state){
  LIST_ID = "global";
  const ref = doc(db, "lists", "global");

  const snap = await getDoc(ref);
  if (snap.exists()){
    const data = snap.data();
    if (Array.isArray(data.items)) state.items = data.items;
  } else {
    await setDoc(ref, { items: state.items, createdAt: serverTimestamp() });
  }

  onSnapshot(ref, s=>{
    if (!s.exists()) return;
    const d = s.data();
    if (Array.isArray(d.items)){
      state.items = d.items;
      render();
    }
  });
}

function cloudSave(){
  if (!LIST_ID) return;
  clearTimeout(cloudSaveTimer);
  cloudSaveTimer = setTimeout(()=>{
    const ref = doc(db, "lists", LIST_ID);
    setDoc(ref, { items: state.items, updatedAt: serverTimestamp() }, { merge:true });
  }, 200);
}

function buildShareUrl(){
  const u = new URL(location.origin + location.pathname);
  u.searchParams.set("list", LIST_ID || ensureListId());
  return u.toString();
}

/* ===== FIX MINIMO ===== */
function buildShareUrlShort(){ return buildShareUrl(); }
    
    const CONFIG = {
      imageBasePath: "./images/",
      catalog: [
        { name: "LECHE", img: "leche.jpg" },
        { name: "PAN", img: "panintegral.jpg" },
        { name: "HUEVOS", img: "huevos.jpg" },
        { name: "AGUA", img: "agua.jpg" },
        { name: "TIRAS", img: "tiras.jpg" },
        { name: "ACEITE", img: "aceite.jpg" },
        { name: "AZ√öCAR", img: "azucar.jpg" },
        { name: "SAL", img: "sal.jpg" },
        { name: "YOGUR", img: "yogurgrande.jpg" },
      ]
    };

    const state = {
      activeScreen: "search", // "search" | "list"
      searchText: "",
      items: [],
      detail: {
        isOpen: false,
        origin: "search", // "search" | "list"
        mode: "add",      // "add" | "edit"
        itemId: null,
        name: "",
        img: null,
        qty: 1
      }
    };

    const STORAGE_KEY = "compra_list_v1";
    function saveStateToStorage(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: state.items }));
    }
    function loadStateFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data && Array.isArray(data.items)) state.items = data.items;
      }catch(_){}
    }

    const $ = (sel, root=document) => root.querySelector(sel);
    const norm = (s) => (s ?? "").toString().trim().toUpperCase();
    const contains = (haystack, needle) => {
      const h = norm(haystack);
      const n = norm(needle);
      return n.length === 0 ? true : h.includes(n);
    };
    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
    const imgUrl = (imgName) => imgName ? (CONFIG.imageBasePath + imgName) : null;

    function navTo(screen){
      state.activeScreen = screen;
      render();
    }

    function render(){
      $("#screenSearch").classList.toggle("is-active", state.activeScreen === "search");
      $("#screenList").classList.toggle("is-active", state.activeScreen === "list");

      const s = $("#appStatus");
if (s) s.textContent = navigator.onLine ? "online" : "offline";

      renderSearch();
      renderList();
      renderDetail();
    }

    function renderSearch(){
      if (state.activeScreen !== "search") return;

      $("#searchInput").value = state.searchText;

      const results = CONFIG.catalog.filter(p => contains(p.name, state.searchText));

      const grid = $("#productGrid");
      grid.innerHTML = "";
      for (const p of results){
        const el = document.createElement("div");
        el.className = "pitem";
        el.setAttribute("role","listitem");
        el.innerHTML = `
          <div class="img">${p.img ? `<img alt="${p.name}" src="${imgUrl(p.img)}" loading="lazy">` : ""}</div>
          <div class="label" title="${p.name}">${p.name}</div>
        `;
        el.addEventListener("click", () => openDetailFromSearch(p));
        grid.appendChild(el);
      }

      const showFree = norm(state.searchText).length > 0 && results.length === 0;
      $("#addFreeBox").classList.toggle("is-visible", showFree);
      $("#freeText").textContent = norm(state.searchText);
    }

    function renderList(){
      if (state.activeScreen !== "list") return;

      const wrap = $("#shoppingList");
      wrap.innerHTML = "";

      const items = [...state.items].sort((a,b)=>((a.order ?? 0) - (b.order ?? 0)));
     
const btnDelete = $("#btnDeleteList");
if (btnDelete) {
  btnDelete.style.display = state.items.length ? "inline-flex" : "none";
}
      for (const it of items){
        const li = document.createElement("div");
        li.className = "li";

        const thumb = it.img
          ? `<div class="thumb"><img alt="${it.name}" src="${imgUrl(it.img)}" loading="lazy"></div>`
          : `<div class="thumb" aria-hidden="true">‚Äî</div>`;

        li.innerHTML = `
          ${thumb}
          <div class="meta">
            <p class="name" title="${it.name}">${it.name}</p>
            <p class="sub">${it.img ? "Con foto" : "Sin foto"}</p>
          </div>
          <div class="qty">
            <div class="pill" aria-label="Cantidad">${it.qty}</div>
            <button class="btn ghost" type="button" data-act="delete" title="Eliminar">üóëÔ∏è</button>
          </div>
        `;

        li.addEventListener("click", (ev)=>{
          const btn = ev.target.closest('button[data-act="delete"]');
          if (btn) return;
          openDetailFromList(it);
        });

        li.querySelector('button[data-act="delete"]').addEventListener("click", (ev)=>{
          ev.stopPropagation();
          deleteItem(it.id);
        });

        wrap.appendChild(li);
      }
    }

    function renderDetail(){
      $("#detailBackdrop").classList.toggle("is-open", state.detail.isOpen);
      if (!state.detail.isOpen) return;

      $("#detailTitle").textContent = state.detail.name;
      $("#detailQty").textContent = String(state.detail.qty);

      const photo = $("#detailPhoto");
      photo.innerHTML = "";
      if (state.detail.img){
        const img = document.createElement("img");
        img.alt = state.detail.name;
        img.src = imgUrl(state.detail.img);
        img.loading = "lazy";
        photo.appendChild(img);
      }else{
        const span = document.createElement("span");
        span.textContent = "SIN FOTO";
        photo.appendChild(span);
      }

      const isEdit = state.detail.mode === "edit";
      $("#btnConfirmDetail").textContent = isEdit ? "Actualizar" : "A√±adir";
      $("#btnDeleteItem").style.display = isEdit ? "inline-flex" : "none";
    }

    function openDetailFromSearch(p){
      state.detail = { isOpen:true, origin:"search", mode:"add", itemId:null, name:p.name, img:p.img||null, qty:1 };
      renderDetail();
    }

    function openDetailFromList(it){
      state.detail = { isOpen:true, origin:"list", mode:"edit", itemId:it.id, name:it.name, img:it.img||null, qty:it.qty };
      renderDetail();
    }

    function closeDetail(){
      const origin = state.detail.origin;
      state.detail.isOpen = false;
      render();
      navTo(origin);
    }

    function addItem({ name, img=null, qty=1 }){
      const maxOrder = state.items.length ? Math.max(...state.items.map(x=> (x.order ?? 0))) : 0;
      const order = maxOrder + 1;
      state.items.push({ id: uid(), name: norm(name), img, qty: Math.max(1, qty|0), order });
      saveStateToStorage();
      cloudSave();
      render();
    }

    function updateItem(id, patch){
      const it = state.items.find(x=>x.id===id);
      if (!it) return;
      if (patch.qty != null) it.qty = Math.max(1, patch.qty|0);
      saveStateToStorage();
      cloudSave();
      render();
    }

    function deleteItem(id){
      state.items = state.items.filter(x=>x.id!==id);
      saveStateToStorage();
      cloudSave();
      render();
    }

    function clearList(){
      state.items = [];
      saveStateToStorage();
      cloudSave();
      render();
    }

    document.addEventListener("click", (ev)=>{
      const b = ev.target.closest("[data-nav]");
      if (!b) return;
      const screen = b.dataset.nav;
      if (screen === "search") navTo("search");
      if (screen === "list") navTo("list");
    });

    $("#searchInput").addEventListener("input", (ev)=>{
      state.searchText = ev.target.value || "";
      renderSearch();
    });

   

   $("#btnAddFree").addEventListener("click", ()=>{
  const name = norm(state.searchText);
  if (!name) return;
  addItem({ name, img: null, qty: 1 });

  // UX: al a√±adir ‚Äúlibre‚Äù, vuelve a Buscar (feedback inmediato)
  state.searchText = "";
  navTo("search");      // o "search" si ya est√°s ah√≠, fuerza render y se nota la acci√≥n
  $("#searchInput")?.focus();
});

    $("#btnCloseDetail").addEventListener("click", closeDetail);
    $("#detailBackdrop").addEventListener("click", (ev)=>{
      if (ev.target === $("#detailBackdrop")) closeDetail();
    });

    $("#btnQtyMinus").addEventListener("click", ()=>{
      state.detail.qty = Math.max(1, state.detail.qty - 1);
      renderDetail();
    });
    $("#btnQtyPlus").addEventListener("click", ()=>{
      state.detail.qty = state.detail.qty + 1;
      renderDetail();
    });

    $("#btnConfirmDetail").addEventListener("click", ()=>{
      if (state.detail.mode === "add"){
        addItem({ name: state.detail.name, img: state.detail.img, qty: state.detail.qty });
        closeDetail();
      }else{
        updateItem(state.detail.itemId, { qty: state.detail.qty });
        closeDetail();
      }
    });

    $("#btnDeleteItem").addEventListener("click", ()=>{
      if (state.detail.mode !== "edit") return;
      deleteItem(state.detail.itemId);
      closeDetail();
    });

    $("#btnDeleteList").addEventListener("click", ()=>{
      $("#dlgDeleteList").showModal();
    });
    $("#dlgCancel").addEventListener("click", ()=>$("#dlgDeleteList").close());
    $("#dlgConfirm").addEventListener("click", ()=>{
      $("#dlgDeleteList").close();
      clearList();
    });

    window.addEventListener("online", render);
    window.addEventListener("offline", render);

    // Arranque:
    // - Por defecto: SEARCH
    // - Si viene con ?list= : al cargar nube, cambiamos a LIST
    function boot(){
      loadStateFromStorage();
      state.activeScreen = "search";
      render();
      cloudInit(state);
    }
    boot();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js");
      });
    }
  </script>
</body>
</html>
